let move_target,resize_target;browser.storage.local.get().then(function(e){if(e.separate_categories?(e.categories_toolbar&&browser.bookmarks.get("toolbar_____").then(function(e){fetchFolder(e[0])}),e.categories_menu&&browser.bookmarks.get("menu________").then(function(e){fetchFolder(e[0])}),e.categories_mobile&&browser.bookmarks.get("mobile______").then(function(e){fetchFolder(e[0])}),e.categories_other&&browser.bookmarks.get("unfiled_____").then(function(e){fetchFolder(e[0])})):(e.categories_toolbar&&browser.bookmarks.getChildren("toolbar_____").then(function(e){let t=e.length;for(let o=0;o<t;++o)fetchFolder(e[o])}),e.categories_menu&&browser.bookmarks.getChildren("menu________").then(function(e){let t=e.length;for(let o=0;o<t;++o)fetchFolder(e[o])}),e.categories_mobile&&browser.bookmarks.getChildren("mobile______").then(function(e){let t=e.length;for(let o=0;o<t;++o)fetchFolder(e[o])}),e.categories_other&&browser.bookmarks.getChildren("unfiled_____").then(function(e){let t=e.length;for(let o=0;o<t;++o)fetchFolder(e[o])})),e.windows){let t=Object.keys(e.windows),o=1;for(let r of t){let t=e.windows[r];drawWindow(t.id,t.title,t.x,t.y,t.w,t.h,o++),registerWindow("win_"+t.id),populateWindow(t.id)}}e.custom_css&&document.head.insertAdjacentHTML("beforeend","<style>"+e.custom_css+"</style>"),e.show_search_tips&&(document.getElementById("tip_container").style.display="block"),0===Object.entries(e).length&&(browser.runtime.setUninstallURL("http://zarch.info/UMiBO/uninstalled.html"),browser.storage.local.set({categories_toolbar:!0,show_search_tips:!0,custom_css:null}),location.reload())});let closing=!1;function registerFolder(e){document.getElementById(e).addEventListener("click",function(e){folderId=e.target.id,null==document.getElementById("win_"+folderId)&&(folderTitle=e.target.innerHTML,len=document.getElementsByClassName("window").length,drawWindow(folderId,folderTitle,e.clientX-200,e.clientY+50,400,300,len),registerWindow("win_"+folderId),populateWindow(folderId),browser.storage.local.get().then(function(t){t.windows?arr_windows=t.windows:arr_windows=[],arr_windows[folderId]={id:folderId,title:folderTitle,y:e.clientY+50,x:e.clientX-200,h:300,w:400,z:len},browser.storage.local.set({windows:arr_windows})}))})}function registerWindow(e){let t=document.getElementById(e);t.childNodes[0].addEventListener("mousedown",function(e){offsetX=e.pageX-e.currentTarget.parentNode.offsetLeft,offsetY=e.pageY-e.currentTarget.parentNode.offsetTop,move_target=e.currentTarget.parentNode,document.body.insertAdjacentHTML("beforeend",'<div id="secureDrag"></div>')}),t.addEventListener("mousedown",function(e){let t=document.getElementsByClassName("window");for(let o=0;o<t.length;o++)t[o].style.zIndex>0&&e.currentTarget.style.zIndex!==t.length&&(t[o].style.zIndex--,t[o].classList.remove("firstWindow"));e.currentTarget.style.zIndex=t.length,e.currentTarget.classList.add("firstWindow")}),t.childNodes[0].childNodes[1].addEventListener("mousedown",function(t){t.target.parentNode.parentNode.remove(),e=t.target.parentNode.parentNode.getAttribute("index"),browser.storage.local.get().then(function(t){let o=t.windows;delete o[e],browser.storage.local.set({windows:o})}),closing=!0}),t.childNodes[2].addEventListener("mousedown",function(e){pX=e.pageX,pY=e.pageY,wH=e.currentTarget.parentNode.childNodes[1].offsetHeight,wW=e.currentTarget.parentNode.childNodes[1].offsetWidth,resize_target=e.currentTarget.parentNode,document.body.insertAdjacentHTML("beforeend",'<div id="secureDrag"></div>')})}function populateWindow(e){browser.bookmarks.getChildren(e).then(function(t){let o=document.getElementById("win_"+e).childNodes[1],r=t.length;for(let e=0;e<r;++e){let r=t[e];"bookmark"===r.type?(""===r.title&&(r.title=r.url),o.insertAdjacentHTML("beforeend",'<a id="'+r.id+'" title="'+r.title+'" href="'+r.url+'"><img loading="lazy" width="16px" height="16px" src="https://s2.googleusercontent.com/s2/favicons?domain_url='+r.url+'"/>'+r.title+"</a>"),dragonPrepare(r.id)):"folder"===r.type?(o.insertAdjacentHTML("beforeend",'<article id="'+r.id+'" title="'+r.title+'" href="'+r.id+'" draggable="true">'+r.title+"</article>"),registerFolder(r.id),dragonPrepare(r.id)):o.insertAdjacentHTML("beforeend","<hr>")}})}function fetchFolder(e){"bookmark"===e.type?(document.body.insertAdjacentHTML("beforeend",'<a id="'+e.id+'" title="'+e.title+'" class="desktopFolder" href="'+e.url+'"><img width="16px" height="16px" src="https://s2.googleusercontent.com/s2/favicons?domain_url='+e.url+'"/>'+e.title+"</a>"),dragonPrepare(e.id)):"folder"===e.type?(document.body.insertAdjacentHTML("beforeend",'<div class="desktopFolder" id="'+e.id+'" title="'+e.title+'" href="'+e.id+'" draggable="true">'+e.title+"</div>"),registerFolder(e.id),dragonPrepare(e.id)):document.body.insertAdjacentHTML("beforeend","<hr>")}function dragonPrepare(e){document.getElementById(e).addEventListener("dragstart",function(e){dragon_target=e.currentTarget.id,Dropzones=document.getElementsByClassName("dropzone");for(let e=0;e<Dropzones.length;++e)Dropzones[e].style.display="block",Dropzones[e].addEventListener("dragenter",function(e){drop_target=e.target.getAttribute("id").replace("drop_","")});document.getElementById("delete_vortex").style.display="block"})}function drawWindow(e,t,o,r,n,d,i){r<0&&(r=0),r+d/2>window.innerHeight&&(r=window.innerHeight-d),o<0&&(o=0),o+n/2>window.innerWidth&&(o=window.innerWidth-n),document.body.insertAdjacentHTML("beforeend",'<div id="win_'+e+'" index="'+e+'" style="top:'+r+"px; left:"+o+"px;z-index:"+i+'" class="window"><div class="border" title="'+t+'">'+t+'<span id="close_button" title="Close"></span></div><main style="height:'+d+"px;width:"+n+'px"></main><div class="resize"></div><div class="dropzone" id="drop_'+e+'"></div></div>')}document.body.addEventListener("mousemove",function(e){move_target?(move_target.style.left=e.pageX-offsetX+"px",move_target.style.top=e.pageY-offsetY+"px"):resize_target&&(resize_target.childNodes[1].style.height=wH+e.pageY-pY+"px",resize_target.childNodes[1].style.width=wW+e.pageX-pX+"px")}),document.body.addEventListener("mouseup",function(){if(move_target||resize_target){let e=resize_target||move_target;!1===closing&&browser.storage.local.get().then(function(t){t.windows?arr_windows=t.windows:arr_windows=[],arr_windows[e.getAttribute("index")]={id:e.getAttribute("index"),title:e.childNodes[0].title,x:e.offsetLeft,y:e.offsetTop,w:e.childNodes[1].offsetWidth,h:e.childNodes[1].offsetHeight},browser.storage.local.set({windows:arr_windows})}),move_target=null,resize_target=null}closing=!1,null!==document.getElementById("secureDrag")&&(document.getElementById("secureDrag").outerHTML="")}),document.getElementById("delete_vortex").addEventListener("dragenter",function(){null!=dragon_target&&(delete_drop_target=!0,drop_target=null)}),document.addEventListener("dragend",function(){if(dragon_target&&drop_target){browser.bookmarks.move(dragon_target,{parentId:drop_target});let e=document.getElementById(dragon_target);document.getElementById("win_"+drop_target).childNodes[1].insertAdjacentHTML("beforeend",e.outerHTML),e.remove(),dragonPrepare(dragon_target),"ARTICLE"===e.tagName&&registerFolder(dragon_target)}else dragon_target&&!0===delete_drop_target&&browser.bookmarks.remove(dragon_target).then(function(){document.getElementById(dragon_target).remove()});for(let e=0;e<Dropzones.length;++e)Dropzones[e].style.display="none";delete_drop_target=!1,drop_target=null,document.getElementById("delete_vortex").style.display="none"});